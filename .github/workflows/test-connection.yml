name: Test Server Connection

# æ‰‹åŠ¨è§¦å‘æµ‹è¯•
on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'é€‰æ‹©æµ‹è¯•ç±»å‹'
        required: true
        default: 'connection'
        type: choice
        options:
        - connection
        - file_transfer
        - full_test

# ç¯å¢ƒå˜é‡
env:
  DEPLOY_PATH: '/opt/1panel/apps/openresty/openresty/www/sites/xn--ldry53fxxejua/index'
  TEST_FILE_NAME: 'test_deployment.txt'

jobs:
  # æµ‹è¯•æœåŠ¡å™¨è¿æ¥
  test-connection:
    name: Test Server Connection
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'connection' || github.event.inputs.test_type == 'full_test'
    
    steps:
      - name: Test SSH Connection ğŸ”—
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DR_HOST }}
          username: ${{ secrets.DR_USER }}
          password: ${{ secrets.DR_PASS }}
          script: |
            echo "ğŸ”— Testing SSH connection..."
            echo "ğŸ“‹ Server info:"
            echo "  - Hostname: $(hostname)"
            echo "  - Current user: $(whoami)"
            echo "  - Current directory: $(pwd)"
            echo "  - System: $(uname -a)"
            echo "  - Disk space: $(df -h /)"
            
            echo "\nğŸ“‚ Testing target directory access..."
            echo "  - Target path: ${{ env.DEPLOY_PATH }}"
            
            # æµ‹è¯•ç›®å½•æƒé™
            if [ -d "${{ env.DEPLOY_PATH }}" ]; then
              echo "  âœ… Directory exists"
              echo "  - Permissions: $(ls -ld ${{ env.DEPLOY_PATH }})"
              echo "  - Contents: $(ls -la ${{ env.DEPLOY_PATH }}/ | wc -l) items"
            else
              echo "  âš ï¸ Directory does not exist, will create..."
              mkdir -p ${{ env.DEPLOY_PATH }}
              echo "  âœ… Directory created successfully"
            fi
            
            # æµ‹è¯•å†™å…¥æƒé™
            TEST_FILE="${{ env.DEPLOY_PATH }}/${{ env.TEST_FILE_NAME }}"
            echo "Testing write permissions..." > "$TEST_FILE"
            if [ -f "$TEST_FILE" ]; then
              echo "  âœ… Write permission confirmed"
              rm "$TEST_FILE"
            else
              echo "  âŒ Write permission denied"
              exit 1
            fi
            
            echo "\nğŸ‰ SSH connection test completed successfully!"

  # æµ‹è¯•æ–‡ä»¶ä¼ è¾“
  test-file-transfer:
    name: Test File Transfer
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'file_transfer' || github.event.inputs.test_type == 'full_test'
    
    steps:
      # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
      - name: Create Test Files ğŸ“
        run: |
          echo "ğŸ”§ Creating test files..."
          mkdir -p test_files
          
          # åˆ›å»ºå¤šä¸ªæµ‹è¯•æ–‡ä»¶
          echo "Hello from GitHub Actions! $(date)" > test_files/test1.txt
          echo "This is a test deployment file." > test_files/test2.txt
          echo '{"message": "Test JSON file", "timestamp": "'$(date -Iseconds)'"}' > test_files/test.json
          
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„HTMLæ–‡ä»¶
          cat > test_files/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Deployment Test</title>
              <style>
                  body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                  .success { color: green; }
              </style>
          </head>
          <body>
              <h1 class="success">ğŸ‰ Deployment Test Successful!</h1>
              <p>This file was deployed via GitHub Actions</p>
              <p>Deployment time: <script>document.write(new Date().toLocaleString());</script></p>
          </body>
          </html>
          EOF
          
          echo "ğŸ“‹ Created test files:"
          ls -la test_files/
          echo "ğŸ“Š Total size: $(du -sh test_files/)"

      # å‡†å¤‡æœåŠ¡å™¨æµ‹è¯•ç›®å½•
      - name: Prepare Test Directory ğŸ—‚ï¸
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DR_HOST }}
          username: ${{ secrets.DR_USER }}
          password: ${{ secrets.DR_PASS }}
          script: |
            echo "ğŸ—‚ï¸ Preparing test directory..."
            
            TEST_DIR="${{ env.DEPLOY_PATH }}/test_$(date +%Y%m%d_%H%M%S)"
            echo "ğŸ“‚ Test directory: $TEST_DIR"
            
            # åˆ›å»ºæµ‹è¯•ç›®å½•
            mkdir -p "$TEST_DIR"
            echo "âœ… Test directory created"
            
            # ä¿å­˜æµ‹è¯•ç›®å½•è·¯å¾„ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "TEST_DIR=$TEST_DIR" >> $GITHUB_ENV

      # ä¼ è¾“æµ‹è¯•æ–‡ä»¶
      - name: Transfer Test Files ğŸ“¤
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DR_HOST }}
          username: ${{ secrets.DR_USER }}
          password: ${{ secrets.DR_PASS }}
          source: "test_files/*"
          target: "${{ env.DEPLOY_PATH }}/test_$(date +%Y%m%d_%H%M%S)/"
          strip_components: 1
          overwrite: true

      # éªŒè¯æ–‡ä»¶ä¼ è¾“
      - name: Verify File Transfer ğŸ”
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DR_HOST }}
          username: ${{ secrets.DR_USER }}
          password: ${{ secrets.DR_PASS }}
          script: |
            echo "ğŸ” Verifying file transfer..."
            
            # æŸ¥æ‰¾æœ€æ–°çš„æµ‹è¯•ç›®å½•
            LATEST_TEST_DIR=$(ls -td ${{ env.DEPLOY_PATH }}/test_* | head -n 1)
            echo "ğŸ“‚ Checking directory: $LATEST_TEST_DIR"
            
            if [ -d "$LATEST_TEST_DIR" ]; then
              echo "âœ… Test directory found"
              echo "ğŸ“‹ Transferred files:"
              ls -la "$LATEST_TEST_DIR"/
              
              echo "\nğŸ“„ File contents verification:"
              
              # éªŒè¯æ–‡æœ¬æ–‡ä»¶
              if [ -f "$LATEST_TEST_DIR/test1.txt" ]; then
                echo "  âœ… test1.txt: $(cat $LATEST_TEST_DIR/test1.txt)"
              else
                echo "  âŒ test1.txt not found"
              fi
              
              # éªŒè¯JSONæ–‡ä»¶
              if [ -f "$LATEST_TEST_DIR/test.json" ]; then
                echo "  âœ… test.json: $(cat $LATEST_TEST_DIR/test.json)"
              else
                echo "  âŒ test.json not found"
              fi
              
              # éªŒè¯HTMLæ–‡ä»¶
              if [ -f "$LATEST_TEST_DIR/index.html" ]; then
                echo "  âœ… index.html: $(wc -l < $LATEST_TEST_DIR/index.html) lines"
              else
                echo "  âŒ index.html not found"
              fi
              
              echo "\nğŸ“Š Transfer summary:"
              echo "  - Total files: $(find $LATEST_TEST_DIR -type f | wc -l)"
              echo "  - Total size: $(du -sh $LATEST_TEST_DIR | cut -f1)"
              
              echo "\nğŸ‰ File transfer test completed successfully!"
              
              # æ¸…ç†æµ‹è¯•æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
              echo "\nğŸ§¹ Cleaning up test files..."
              rm -rf "$LATEST_TEST_DIR"
              echo "âœ… Test files cleaned up"
              
            else
              echo "âŒ Test directory not found - transfer failed"
              exit 1
            fi

  # æµ‹è¯•ç»“æœæ±‡æ€»
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-connection, test-file-transfer]
    if: always()
    
    steps:
      - name: Generate Test Report ğŸ“Š
        run: |
          echo "ğŸ“Š Test Summary Report"
          echo "====================="
          echo "Test Type: ${{ github.event.inputs.test_type }}"
          echo "Execution Time: $(date)"
          echo ""
          
          # æ£€æŸ¥å„ä¸ªä½œä¸šçš„çŠ¶æ€
          CONNECTION_STATUS="${{ needs.test-connection.result }}"
          TRANSFER_STATUS="${{ needs.test-file-transfer.result }}"
          
          echo "ğŸ“‹ Test Results:"
          
          if [ "$CONNECTION_STATUS" = "success" ]; then
            echo "  âœ… Server Connection: PASSED"
          elif [ "$CONNECTION_STATUS" = "skipped" ]; then
            echo "  â­ï¸ Server Connection: SKIPPED"
          else
            echo "  âŒ Server Connection: FAILED"
          fi
          
          if [ "$TRANSFER_STATUS" = "success" ]; then
            echo "  âœ… File Transfer: PASSED"
          elif [ "$TRANSFER_STATUS" = "skipped" ]; then
            echo "  â­ï¸ File Transfer: SKIPPED"
          else
            echo "  âŒ File Transfer: FAILED"
          fi
          
          echo ""
          
          # æ€»ä½“çŠ¶æ€
          if [ "$CONNECTION_STATUS" = "success" ] && [ "$TRANSFER_STATUS" = "success" ]; then
            echo "ğŸ‰ Overall Status: ALL TESTS PASSED"
            echo "âœ… Your server configuration is working correctly!"
          elif [ "$CONNECTION_STATUS" = "success" ] || [ "$TRANSFER_STATUS" = "success" ]; then
            echo "âš ï¸ Overall Status: PARTIAL SUCCESS"
            echo "Some tests passed, please check the failed ones."
          else
            echo "âŒ Overall Status: TESTS FAILED"
            echo "Please check your server configuration and secrets."
          fi
          
          echo ""
          echo "ğŸ’¡ Next Steps:"
          echo "  - If all tests passed, your main deployment workflow should work"
          echo "  - If tests failed, check your GitHub Secrets and server configuration"
          echo "  - Review the detailed logs above for specific error messages"