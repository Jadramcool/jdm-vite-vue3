name: Build and Deploy

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [master]
  workflow_dispatch:

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '20'
  PNPM_VERSION: 'latest'
  DEPLOY_PATH: '/opt/1panel/apps/openresty/openresty/www/sites/xn--ldry53fxxejua/index'

jobs:
  # æ„å»ºä½œä¸š
  build:
    name: Build Project
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Repository ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºç‰ˆæœ¬æ ‡è®°

      # 2. è®¾ç½® pnpm
      - name: Setup pnpm ğŸ“¦
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js ${{ env.NODE_VERSION }} ğŸŸ¢
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      # 4. å®‰è£…ä¾èµ–
      - name: Install Dependencies ğŸ“¥
        run: |
          echo "ğŸ“‹ pnpm version: $(pnpm --version)"
          echo "ğŸ“‹ Node.js version: $(node --version)"
          pnpm install --frozen-lockfile

      # 5. ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Code Quality Check ğŸ”
        run: |
          echo "ğŸ” Running linting..."
          pnpm run lint || echo "âš ï¸ Linting failed, but continuing..."

      # 6. æ„å»ºé¡¹ç›®
      - name: Build Project ğŸ—ï¸
        run: |
          echo "ğŸ—ï¸ Building project..."
          pnpm run build
          echo "âœ… Build completed successfully"

      # 7. éªŒè¯æ„å»ºäº§ç‰©
      - name: Verify Build Output ğŸ“‹
        run: |
          echo "ğŸ“‹ Verifying build output..."
          ls -la dist/
          echo "ğŸ“Š Build size:"
          du -sh dist/

      # 8. ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload Build Artifacts ğŸ“¤
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: dist/
          retention-days: 7

  # éƒ¨ç½²ä½œä¸š
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: success()
    
    steps:
      # 1. ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download Build Artifacts ğŸ“¥
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: dist/

      # 2. éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
      - name: Verify Downloaded Files ğŸ“‹
        run: |
          echo "ğŸ“‹ Downloaded files:"
          ls -la dist/
          echo "ğŸ“Š Total size:"
          du -sh dist/

      # 3. å‡†å¤‡æœåŠ¡å™¨ç›®å½•
      - name: Prepare Server Directory ğŸ—‚ï¸
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DR_HOST }}
          username: ${{ secrets.DR_USER }}
          password: ${{ secrets.DR_PASS }}
          script: |
            echo "ğŸ—‚ï¸ Preparing deployment directory..."
            
            # åˆ›å»ºå¤‡ä»½ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            mkdir -p ${{ env.DEPLOY_PATH }}/backup
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "${{ env.DEPLOY_PATH }}/dist" ] && [ "$(ls -A ${{ env.DEPLOY_PATH }}/dist)" ]; then
              echo "ğŸ’¾ Backing up current version..."
              BACKUP_NAME="backup_$(date +%Y%m%d_%H%M%S)"
              mv ${{ env.DEPLOY_PATH }}/dist ${{ env.DEPLOY_PATH }}/backup/$BACKUP_NAME
              echo "âœ… Backup created: $BACKUP_NAME"
              
              # ä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
              cd ${{ env.DEPLOY_PATH }}/backup
              ls -t | tail -n +6 | xargs -r rm -rf
              echo "ğŸ§¹ Old backups cleaned up"
            fi
            
            # ç¡®ä¿éƒ¨ç½²æ ¹ç›®å½•å­˜åœ¨
            mkdir -p ${{ env.DEPLOY_PATH }}
            echo "âœ… Directory prepared successfully"

      # 4. éƒ¨ç½²æ–‡ä»¶åˆ°æœåŠ¡å™¨
      - name: Deploy Files to Server ğŸš€
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DR_HOST }}
          username: ${{ secrets.DR_USER }}
          password: ${{ secrets.DR_PASS }}
          source: "dist"
          target: ${{ env.DEPLOY_PATH }}/
          overwrite: true
          debug: true

      # 5. ç«‹å³æ£€æŸ¥æ–‡ä»¶ä¼ è¾“ç»“æœ
      - name: Check File Transfer ğŸ“‹
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DR_HOST }}
          username: ${{ secrets.DR_USER }}
          password: ${{ secrets.DR_PASS }}
          script: |
            echo "ğŸ“‹ Checking file transfer immediately after scp..."
            echo "ğŸ“ Target path: ${{ env.DEPLOY_PATH }}/dist/"
            
            if [ -d "${{ env.DEPLOY_PATH }}/dist" ]; then
              echo "âœ… Target directory exists"
              echo "ğŸ“‹ Directory contents:"
              ls -la ${{ env.DEPLOY_PATH }}/dist/
              echo "ğŸ“Š File count: $(find ${{ env.DEPLOY_PATH }}/dist -type f | wc -l)"
            else
              echo "âŒ Target directory does not exist"
              echo "ğŸ“‹ Parent directory contents:"
              ls -la ${{ env.DEPLOY_PATH }}/
            fi

      # 6. éªŒè¯éƒ¨ç½²ç»“æœ
      - name: Verify Deployment ğŸ”
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DR_HOST }}
          username: ${{ secrets.DR_USER }}
          password: ${{ secrets.DR_PASS }}
          script: |
            echo "ğŸ” Verifying deployment..."
            echo "ğŸ“ Deploy path: ${{ env.DEPLOY_PATH }}"
            echo "ğŸ“ Target directory: ${{ env.DEPLOY_PATH }}/dist"
            
            # æ£€æŸ¥éƒ¨ç½²è·¯å¾„æ˜¯å¦å­˜åœ¨
            if [ ! -d "${{ env.DEPLOY_PATH }}" ]; then
              echo "âŒ Deploy path does not exist: ${{ env.DEPLOY_PATH }}"
              exit 1
            fi
            
            # æ£€æŸ¥ç›®æ ‡ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "${{ env.DEPLOY_PATH }}/dist" ]; then
              echo "âŒ Target directory does not exist: ${{ env.DEPLOY_PATH }}/dist"
              echo "ğŸ“‹ Contents of deploy path:"
              ls -la ${{ env.DEPLOY_PATH }}/
              exit 1
            fi
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ "$(ls -A ${{ env.DEPLOY_PATH }}/dist)" ]; then
              echo "âœ… Files deployed successfully"
              echo "ğŸ“‹ Deployed files:"
              ls -la ${{ env.DEPLOY_PATH }}/dist/
              echo "ğŸ“Š Total size:"
              du -sh ${{ env.DEPLOY_PATH }}/dist/
            else
              echo "âŒ Target directory is empty: ${{ env.DEPLOY_PATH }}/dist"
              echo "ğŸ“‹ Directory permissions:"
              ls -ld ${{ env.DEPLOY_PATH }}/dist/
              exit 1
            fi
            
            # è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
            echo "ğŸ”§ Setting file permissions..."
            find ${{ env.DEPLOY_PATH }}/dist -type f -exec chmod 644 {} \;
            find ${{ env.DEPLOY_PATH }}/dist -type d -exec chmod 755 {} \;
            echo "âœ… Permissions set successfully"

      # 7. éƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: Deployment Success Notification ğŸ‰
        if: success()
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“… Deployment time: $(date)"
          echo "ğŸ”— Site should be available at your configured domain"

      # 8. éƒ¨ç½²å¤±è´¥å›æ»š
      - name: Rollback on Failure ğŸ”„
        if: failure()
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DR_HOST }}
          username: ${{ secrets.DR_USER }}
          password: ${{ secrets.DR_PASS }}
          script: |
            echo "ğŸ”„ Deployment failed, attempting rollback..."
            
            # æŸ¥æ‰¾æœ€æ–°çš„å¤‡ä»½
            LATEST_BACKUP=$(ls -t ${{ env.DEPLOY_PATH }}/backup/ | head -n 1)
            
            if [ -n "$LATEST_BACKUP" ]; then
              echo "ğŸ“¦ Rolling back to: $LATEST_BACKUP"
              rm -rf ${{ env.DEPLOY_PATH }}/dist
              mv ${{ env.DEPLOY_PATH }}/backup/$LATEST_BACKUP ${{ env.DEPLOY_PATH }}/dist
              echo "âœ… Rollback completed successfully"
            else
              echo "âš ï¸ No backup found for rollback"
            fi
