name: build
on: 
  push: 
    branches: 
      - master
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # 1. å…ˆå®‰è£… pnpmï¼ˆè°ƒæ•´é¡ºåºï¼Œç¡®ä¿åœ¨ä¾èµ–å®‰è£…å‰å®Œæˆï¼‰
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: latest
          run_install: false  # æš‚æ—¶ä¸è‡ªåŠ¨å®‰è£…ä¾èµ–

      # 2. å†è®¾ç½® Node.jsï¼ˆæ­¤æ—¶ pnpm å·²åœ¨ PATH ä¸­ï¼‰
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'  # ç¼“å­˜ pnpm ä¾èµ–

      # 3. æ„å»ºé¡¹ç›®ï¼ˆæ˜ç¡®æŒ‡å®š pnpm è·¯å¾„ï¼Œç¡®ä¿å¯æ‰§è¡Œï¼‰
      - name: Build
        run: |
          # æ‰‹åŠ¨ç¡®è®¤ pnpm ç‰ˆæœ¬ï¼ŒéªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ
          pnpm --version
          # å®‰è£…ä¾èµ–å¹¶æ„å»º
          pnpm install
          pnpm run build

      # éƒ¨ç½²æ­¥éª¤ï¼ˆä¿æŒä¸å˜ï¼‰
      - name: Deploy via SSH ğŸš€
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DR_HOST }}
          username: ${{ secrets.DR_USER }}
          password: ${{ secrets.DR_PASS }}
          script: |
            mkdir -p /opt/1panel/apps/openresty/openresty/www/sites/xn--ldry53fxxejua/index/dist
            rm -rf /opt/1panel/apps/openresty/openresty/www/sites/xn--ldry53fxxejua/index/dist
          scp: |
            ./jdm-vite-vue3/dist/* ${{ secrets.DR_USER }}@${{ secrets.DR_HOST }}:/opt/1panel/apps/openresty/openresty/www/sites/xn--ldry53fxxejua/index/dist
